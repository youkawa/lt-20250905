# 設計文書: Notebook Report Weaver

## 概要

「Notebook Report Weaver」は、データサイエンティストが複数のJupyter Notebookから特定のセル（コード、テキスト、グラフ等）を抽出し、それらを組み合わせてプロフェッショナルなプレゼンテーション形式のレポートを効率的に作成するためのWebアプリケーションである。本システムは、直感的なUI/UXを提供し、レポート作成プロセスを大幅に簡略化する。また、テンプレート機能による品質の標準化、メタデータ管理による分析の再現性確保も実現し、データサイエンティスト、プロジェクトマネージャー、ビジネスステークホルダー間の円滑なコミュニケーションを支援する。

-----

## アーキテクチャ

### 技術スタック

本アプリケーションは、モダンなWeb技術スタックを採用し、スケーラビリティと保守性を確保する。フロントエンドとバックエンドを分離したSPA（Single Page Application）アーキテクチャを基本とし、専門的な処理はマイクロサービスに委譲する。

  - **フロントエンド**:

      - **フレームワーク**: **Next.js 14** (App Router) - 高度なインタラクティビティを実現するため、主にクライアントサイドレンダリング(CSR)で利用。
      - **UIライブラリ**: **Shadcn/ui** - アクセシビリティとカスタマイズ性に優れたUIコンポーネント群。
      - **状態管理**: **Zustand** - シンプルで強力な状態管理ライブラリ。
      - **ドラッグ＆ドロップ**: **dnd-kit** - 高機能でアクセシブルなドラッグ＆ドロップ機能を提供。
      - **Notebookレンダリング**: **`@datalayer/jupyter-ui`** - JupyterLabのコンポーネントをベースとし、Notebookセルを忠実に再現。
      - **型安全性**: **TypeScript**

  - **バックエンド**:

      - **メインAPI**: **Node.js + NestJS** - 認証、プロジェクト管理など主要なビジネスロジックを担当。TypeScriptとの親和性が高い。
      - **Notebook処理サービス (マイクロサービス)**: **Python (FastAPI)** - `nbformat`によるNotebook解析、`python-pptx`によるPPTX生成、`Kaleido`によるグラフの静止画化など、Pythonエコシステムのライブラリを活用する専門的な処理を担当。
      - **データベース**: **PostgreSQL** - 信頼性と拡張性に優れたリレーショナルデータベース。
      - **認証**: **NextAuth.js** - 柔軟な認証フローを容易に実装。
      - **ORマッパー**: **Prisma** - 型安全なデータベースアクセスを実現。

  - **インフラストラクチャ**:

      - **コンテナ化**: **Docker**
      - **デプロイ**: **Vercel** (フロントエンド), **AWS Fargate/ECS** (バックエンド)
      - **CI/CD**: **GitHub Actions**

### アプリケーション構造

フロントエンド、メインAPI、Pythonマイクロサービスの3つの主要なサービスが連携して動作する。

```
// フロントエンド (Next.js) の主要なディレクトリ構造
src/
├── app/
│   └── (main)/
│       └── projects/[projectId]/page.tsx # レポート編集メインページ
├── components/
│   ├── editor/                         # レポートエディタ関連コンポーネント
│   │   ├── ReportCanvas.tsx            # レポート構成要素の編集エリア
│   │   ├── NotebookPanel.tsx           # Notebookセル選択パネル
│   │   └── PreviewPanel.tsx            # リアルタイムプレビュー
│   └── core/
├── lib/                                # APIクライアント、ユーティリティ
└── store/                              # Zustandによる状態管理ストア
```

-----

## コンポーネントとインターフェース

### 主要コンポーネント

#### 1\. ReportEditor

  - **責務**: レポート編集画面全体のコンテナ。各種パネルを統合し、アプリケーションの状態を一元管理する。
  - **主要な機能**: プロジェクトデータの読み込み、コンポーネント間の状態連携、変更の自動保存。

#### 2\. NotebookSelectorPanel

  - **責務**: インポートされたJupyter Notebookのセル一覧を表示し、ユーザーがレポートに含めるセルを選択できるようにする。
  - **主要な機能**: `.ipynb`ファイルのアップロード、`@datalayer/jupyter-ui`を利用したセル単位のプレビュー、セルの選択・検索。

#### 3\. ReportCanvas

  - **責務**: 選択されたセルや新規テキストボックスを配置し、ドラッグ＆ドロップで順序を編集するメイン作業領域。
  - **主要な機能**: レポート構成要素のリスト表示、ドラッグ＆ドロップによる並べ替え、要素の追加・削除、テキスト編集。

#### 4\. PreviewPanel

  - **責務**: `ReportCanvas`で組み立てられたレポートの構成を、選択されたテンプレートに基づいてリアルタイムにプレビュー表示する。
  - **主要な機能**: スライド形式でのプレビュー、テンプレートスタイルの適用、リアルタイム更新。

#### 5\. TemplateManager

  - **責務**: （管理者向け）`.pptx`形式のプレゼンテーションテンプレートをアップロードし、管理する。
  - **主要な機能**: テンプレートのアップロード、一覧表示、デフォルトテンプレートの設定。

#### 6\. ExportModal

  - **責務**: レポートのエクスポート処理を担当。メタデータの最終確認とファイル形式の選択を行う。
  - **主要な機能**: メタデータ入力フォーム、エクスポート形式（PPTX, PDF）の選択、バックエンドへのエクスポート要求。

### インターフェース定義

```typescript
// レポートの定義
interface Report {
  id: string;
  projectId: string;
  version: number;
  metadata: ReportMetadata;
  content: ReportContentItem[];
  templateId: string;
}

// レポートのメタデータ
interface ReportMetadata {
  title: string;
  author: string;
  dataSource: string;
  createdAt: Date;
}

// レポートを構成する要素（Union Type）
type ReportContentItem = NotebookCellItem | TextBoxItem;

// Notebookセル要素
interface NotebookCellItem {
  id: string;
  type: 'notebook_cell';
  sourceNotebook: {
    name: string;
    cellIndex: number;
  };
  // .ipynb のセルJSON構造に準拠
  cellData: object;
}

// テキストボックス要素
interface TextBoxItem {
  id: string;
  type: 'text_box';
  // Tiptapなどのリッチテキストエディタの出力形式（例: HTML）
  content: string;
}

// プレゼンテーションテンプレート
interface Template {
  id: string;
  name: string;
  filePath: string;
  isDefault: boolean;
}
```

-----

## データモデル

### 永続化データ

データベース（PostgreSQL）で以下のデータを永続化する。

  - **Users**: ユーザーアカウント情報（ID, 名前, メール, 役割）。
  - **Projects**: ユーザーが作成するプロジェクト。`Report`のコンテナとなる。
  - **Reports**: レポートの各バージョン。`content`フィールドには、`ReportContentItem`のJSON配列が格納される。
  - **Templates**: 管理者がアップロードした`.pptx`テンプレートの情報（ファイルパスなど）。

### 状態管理

フロントエンドの状態管理は`Zustand`を使用し、以下のストアを定義する。

  - **`useReportStore`**: 現在編集中のレポートの状態（メタデータ、コンテンツ配列、選択中の要素など）を管理。サーバーとのデータの同期も担う。
  - **`useUIStore`**: UIの状態（パネルの表示/非表示、モーダルの開閉など）を管理。

-----

## 主要機能フロー

### データサイエンティストのレポート作成フロー

1.  **プロジェクト作成**: ユーザーはダッシュボードから新しいプロジェクトを作成する。
2.  **Notebookインポート**: `NotebookSelectorPanel`でローカルから複数の`.ipynb`ファイルをアップロードする。
3.  **セル解析・表示**: アップロードされたファイルはメインAPI経由でPythonマイクロサービスに送られ、セル単位のJSONに解析される。フロントエンドは`@datalayer/jupyter-ui`を使いこれを表示する。
4.  **セル選択**: ユーザーはプレビューを見ながら、レポートに含めたいセルを選択する。選択されたセルは`ReportCanvas`に自動的に追加される。
5.  **レポート構成**: `ReportCanvas`上で、ドラッグ＆ドロップを使いセルの順序を並べ替え、テキストスライドを追加・編集する。
6.  **リアルタイムプレビュー**: `PreviewPanel`には、`ReportCanvas`での変更がリアルタイムで反映され、最終的な見た目を確認しながら作業できる。
7.  **エクスポート**: ヘッダーの「エクスポート」ボタンを押すと`ExportModal`が表示される。メタデータを入力し、エクスポートを実行する。
8.  **非同期処理**: フロントエンドはレポートのJSONデータをPythonマイクロサービスに送信。サービスは非同期でPPTXファイルを生成し、完了後、ユーザーはファイルをダウンロードできる。

-----

## エラーハンドリング

  - **Notebook解析エラー**: `.ipynb`ファイルの形式が不正な場合や、Pythonマイクロサービスでの解析に失敗した場合は、ユーザーに具体的なエラーメッセージを表示し、アップロードを中断させる。
  - **エクスポートエラー**: PPTX/PDF生成中にエラーが発生した場合（例: テンプレートファイルが見つからない、画像変換に失敗）、処理を失敗としてマークし、ユーザーに通知する。リトライ可能なエラーの場合は、再試行を促す。
  - **API通信エラー**: フロントエンドとバックエンド間の通信エラーは、共通のエラーハンドリング機構で捕捉し、「通信に失敗しました」等の汎用メッセージや、必要に応じて再試行オプションを表示する。

-----

## テスト戦略

  - **単体テスト (Vitest)**:
      - 状態管理ストア(Zustand)のロジック。
      - ユーティリティ関数（データ変換処理など）。
      - バックエンドの各サービスクラスのビジネスロジック。
  - **コンポーネントテスト (React Testing Library)**:
      - UIコンポーネントが正しくレンダリングされ、ユーザーインタラクション（クリック、ドラッグ＆ドロップ等）が期待通りに状態を更新することを確認する。
  - **E2Eテスト (Playwright)**:
      - ユーザーの主要な操作フロー（ログイン → プロジェクト作成 → レポート作成 → エクスポート）がブラウザ上で正常に完了することを自動テストで保証する。

-----

## 実装詳細

  - **Notebookのグラフ描画とエクスポート**:

      - **プレビュー時**: Plotlyなどのインタラクティブグラフは、`@datalayer/jupyter-ui`が持つJavaScript実行機能により、そのままインタラクティブに表示される。
      - **エクスポート時**: レポートデータがPythonマイクロサービスに送られた際、グラフデータは`Kaleido`ライブラリによって高品質な静的画像（PNG）に変換される。その後、`python-pptx`がその画像をテンプレートの指定されたプレースホルダーに挿入する。

  - **PPTX生成のテンプレート利用**:

      - `python-pptx`は、管理者がアップロードした`.pptx`ファイルを直接読み込む。ファイル内に定義されているスライドマスターやレイアウト（例: 「タイトルのみ」「タイトルとコンテンツ」など）をプログラムから利用し、コンテンツを流し込む。これにより、フォント、色、ロゴ、レイアウトなど、テンプレートのデザインを完全に保持したレポートを生成する。

  - **非同期エクスポート処理**:

      - PPTX生成は数秒〜数十秒かかる可能性があるため、バックエンドで非同期ジョブキュー（例: BullMQ, Celery）を導入する。ユーザーがエクスポートをリクエストすると即座にレスポンスを返し、処理の進捗はWebSocketやポーリングでフロントエンドに通知する。

-----

## パフォーマンス考慮事項

  - **大規模Notebookの処理**: 数百セルを持つような大規模なNotebookを扱う場合、フロントエンドのパフォーマンスが低下する可能性がある。`react-window`や`TanStack Virtual`のようなリスト仮想化ライブラリを導入し、表示領域内のセルのみをレンダリングすることで、DOM要素の数を抑え、パフォーマンスを維持する。
  - **リアルタイムプレビューの最適化**: レポート構成の変更が頻繁に発生する場合、プレビューの再レンダリングがボトルネックになりうる。`debounce`処理を導入し、ユーザーの操作（特にドラッグ中）が一定時間停止した後にプレビューを更新することで、不要なレンダリングを削減する。
  - **バックエンドの負荷分散**: Notebook解析やファイルエクスポートはCPU負荷が高い処理であるため、これらを担当するPythonマイクロサービスは、負荷に応じてスケールアウト可能な構成（例: AWS Fargateのオートスケーリング設定）とする。
